<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover" />
<title>YT Study（iOS 安装版 · v5）</title>

<link rel="manifest" href="./manifest.webmanifest">
<meta name="theme-color" content="#0b0d10">
<link rel="apple-touch-icon" href="./icons/icon-192.png">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

<style>
  /* Theme variables (follow system) */
  :root {
    --bg:#0b0d10; --panel:#12161b; --muted:#98a2b3; --text:#e6edf3; --accent:#4da3ff;
    --border:#1f2630; --danger:#ef4444;
    --safe-top: env(safe-area-inset-top, 0px);
    --safe-bottom: env(safe-area-inset-bottom, 0px);
  }
  @media (prefers-color-scheme: light) {
    :root {
      --bg:#f6f7fb; --panel:#ffffff; --muted:#667085; --text:#0b1321; --accent:#2b7cff;
      --border:#e5e7eb; --danger:#dc2626;
    }
  }

  *{box-sizing:border-box}
  html, body { height: 100%; }
  body{
    margin:0;
    padding-top: calc(var(--safe-top) + 8px); /* notch spacing */
    font:16px/1.5 -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "PingFang SC", "Microsoft YaHei", sans-serif; /* >=16px to prevent iOS zoom */
    background:var(--bg); color:var(--text);
  }
  header,main{max-width:1100px;margin:0 auto;padding:12px}
  .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  .row.tight{gap:6px}
  input{background:var(--panel);color:var(--text);border:1px solid var(--border);border-radius:10px;padding:10px 12px;outline:0;font-size:16px}
  input[type="text"]{flex:1 1 520px}
  input[type="number"]{width:100px}
  button{background:var(--accent);color:#001b33;border:none;border-radius:10px;padding:10px 12px;font-weight:700;font-size:16px}
  button.ghost{background:transparent;color:var(--accent);border:1px solid var(--accent)}
  button.danger{background:var(--danger);color:#2d0a0a}
  .grid{display:grid;gap:12px;grid-template-columns:1fr}
  .card{background:var(--panel);border:1px solid var(--border);border-radius:14px;padding:12px}

  /* Sticky player */
  .sticky { position: sticky; top: calc(var(--safe-top) + 8px); z-index: 20; }
  #playerWrap{aspect-ratio:16/9;background:#000;border-radius:12px;overflow:hidden;position:relative}

  /* Timestamp list */
  .list{display:flex;flex-direction:column;gap:8px;max-height:60vh;overflow:auto}
  .item{border:1px dashed var(--border);border-radius:10px;padding:8px;display:grid;grid-template-columns:auto 1fr auto;gap:8px;align-items:center}
  .item .del{width:32px;height:32px;border-radius:16px;background:transparent;border:1px solid var(--danger);color:var(--danger);font-weight:900;display:flex;align-items:center;justify-content:center;cursor:pointer}
  .item .note{width:100%;padding:8px 10px;border-radius:8px;border:1px solid var(--border);background:transparent;color:var(--text);font-size:16px}
  .item .timebtn{padding:8px 12px;border-radius:999px;border:1px solid var(--border);background:transparent;color:var(--accent);font-weight:700;cursor:pointer;white-space:nowrap}
  .item .note-ghost{display:none;padding:8px 10px;border-radius:8px;border:1px dashed var(--border);background:transparent;color:var(--muted);font-size:14px;cursor:pointer}

  /* Hide Notes toggle */
  body[data-hide-notes="1"] .item .note { display:none; }
  body[data-hide-notes="1"] .item .note-ghost { display:block; }
  body[data-hide-notes="1"] .item { grid-template-columns:auto 1fr auto; }
  .item.peek .note { display:block !important; }
  .item.peek .note-ghost { display:none !important; }

  /* Floating buttons: back, add, forward (stacked) */
  .fab{position: fixed; right: 16px; z-index: 50; width:56px; height:56px; border-radius:28px; font-size:20px;
       display:flex; align-items:center; justify-content:center; box-shadow:0 8px 24px rgba(0,0,0,.35);}
  #fabAdd{ bottom: calc(var(--safe-bottom) + 16px); background:var(--accent); color:#001b33; }
  #fabBack{ bottom: calc(var(--safe-bottom) + 16px + 56px + 12px); background:#1f2a37; color:#e2e8f0; border:1px solid var(--border);}
  #fabFwd{ bottom: calc(var(--safe-bottom) + 16px + (56px + 12px)*2); background:#1f2a37; color:#e2e8f0; border:1px solid var(--border);}
  @media (prefers-color-scheme: light){
    #fabBack,#fabFwd{ background:#eef2ff; color:#1e293b; border:1px solid #c7d2fe; }
  }

  .tiny{font-size:12px;color:var(--muted)}
</style>
</head>
<body>
<header class="card sticky">
  <div id="playerWrap"><div id="player"></div></div>
  <div class="row tight" style="margin-top:10px">
    <input id="url" type="text" placeholder="粘贴 YouTube 链接，例如 https://www.youtube.com/watch?v=dQw4w9WgXcQ" />
    <button id="loadBtn">Load</button>
    <label class="tiny">倒退秒数</label>
    <input id="backseek" type="number" min="0" step="1" value="3" />
    <button id="toggleNotes" class="ghost">隐藏备注：关</button>
    <button id="exportMD" class="ghost">导出 Markdown</button>
    <span class="tiny">当前 <span id="curTime">0:00</span></span>
  </div>
</header>

<main>
  <section class="card">
    <h3>时间点</h3>
    <div class="list" id="timeList"></div>
  </section>
</main>

<!-- Floating Buttons -->
<button id="fabFwd" class="fab" title="快进 +5s">＋5</button>
<button id="fabAdd" class="fab" title="记录时间点">＋</button>
<button id="fabBack" class="fab" title="后退 -5s">−5</button>

<script>
/* ---------- Utils ---------- */
const $=s=>document.querySelector(s);
const fmtTime=s=>{s=Math.max(0,Math.floor(s||0));const h=Math.floor(s/3600),m=Math.floor((s%3600)/60),sec=s%60;return (h?(h+':'):'')+(h?String(m).padStart(2,'0'):m)+':'+String(sec).padStart(2,'0')};
const parseVideoId=u=>{try{if(!u)return'';const x=new URL(u);if(x.hostname.includes('youtu.be'))return x.pathname.slice(1);if(x.searchParams.get('v'))return x.searchParams.get('v');if(x.pathname.startsWith('/shorts/'))return x.pathname.split('/')[2]||'';return''}catch(e){return u}};
const isHttp=location.protocol.startsWith('http');

/* ---------- Clipboard ---------- */
async function copyText(t){
  try{ if(navigator.clipboard && isHttp){ await navigator.clipboard.writeText(t); return true; } }catch(e){}
  const ta=document.createElement('textarea'); ta.value=t; ta.style.position='fixed'; ta.style.opacity='0'; document.body.appendChild(ta);
  ta.focus(); ta.select(); const ok=document.execCommand('copy'); document.body.removeChild(ta); return ok;
}

/* ---------- YouTube IFrame API ---------- */
let player, currentVideoId='', timeTick;
function onYouTubeIframeAPIReady(){
  player=new YT.Player('player',{
    width:'100%',height:'100%',
    videoId:'',
    playerVars:{
      playsinline:1, cc_load_policy:1, enablejsapi:1,
      origin: isHttp?location.origin:undefined,
      modestbranding:1, rel:0, iv_load_policy:3, fs:1
    },
    events:{ onReady:onPlayerReady }
  });
}
function onPlayerReady(){ timeTick=setInterval(()=>{ if(player && player.getCurrentTime){ $('#curTime').textContent=fmtTime(player.getCurrentTime()); }},300); }
(function loadYT(){ const s=document.createElement('script'); s.src="https://www.youtube.com/iframe_api"; document.head.appendChild(s); })();

/* ---------- State ---------- */
const storeKeyGlobal=k=>`ytstudy:${k}`;
const storeKey=k=>`ytstudy:${currentVideoId}:${k}`;
let timeMarks=[];
function saveState(){ if(!currentVideoId) return; localStorage.setItem(storeKey('timeMarks'),JSON.stringify(timeMarks)); }
function loadState(){ timeMarks=JSON.parse(localStorage.getItem(storeKey('timeMarks'))||'[]'); renderTimeMarks(); }

function getBackseek(){ return parseInt(localStorage.getItem(storeKeyGlobal('backseek'))||'3',10) || 0; }
function setBackseek(v){ localStorage.setItem(storeKeyGlobal('backseek'), String(Math.max(0, Math.floor(v||0)))); }

/* ---------- Timestamps UI ---------- */
function renderTimeMarks(){
  const box=$('#timeList'); box.innerHTML='';
  timeMarks.sort((a,b)=>a.t-b.t).forEach((m,i)=>{
    const d=document.createElement('div'); d.className='item';
    d.innerHTML=`<button class="del" data-i="${i}" title="删除">×</button>
      <input class="note" data-i="${i}" value="${(m.label||'').replace(/"/g,'&quot;')}" placeholder="备注（可编辑）" />
      <div class="note-ghost" data-i="${i}">（备注已隐藏，轻点显示）</div>
      <button class="timebtn" data-i="${i}">${fmtTime(m.t)}</button>`;
    box.appendChild(d);
  });
  const back = getBackseek();
  // events
  box.querySelectorAll('button.del').forEach(btn=> btn.onclick=()=>{
    const i=+btn.getAttribute('data-i'); timeMarks.splice(i,1); renderTimeMarks(); saveState();
  });
  box.querySelectorAll('button.timebtn').forEach(btn=> btn.onclick=()=>{
    const i=+btn.getAttribute('data-i'); const m=timeMarks[i]; if(!m) return;
    const start=Math.max(0,(m.t||0)-back); player?.seekTo?.(start,true); player?.playVideo?.();
  });
  box.querySelectorAll('input.note').forEach(inp=> inp.oninput=()=>{
    const i=+inp.getAttribute('data-i'); if(timeMarks[i]){ timeMarks[i].label=inp.value; saveState(); }
  });
  // peek on ghost click
  box.querySelectorAll('.note-ghost').forEach(el=> el.onclick=()=>{
    const i=+el.getAttribute('data-i'); const item=el.closest('.item');
    if(!item) return;
    item.classList.add('peek');
    // auto-hide after 6s
    setTimeout(()=> item.classList.remove('peek'), 6000);
  });
}

/* ---------- Load video ---------- */
$('#loadBtn').onclick=()=>{
  const id=parseVideoId($('#url').value.trim()); if(!id){ alert('请粘贴有效的链接'); return; }
  currentVideoId=id;
  player.loadVideoById(id);
  timeMarks=[]; renderTimeMarks(); saveState(); loadState();
  $('#backseek').value = getBackseek();
};

/* ---------- FABs ---------- */
function addTimestamp(){ const t=Math.floor(player?.getCurrentTime?.()||0); timeMarks.push({t,label:''}); renderTimeMarks(); saveState(); }
$('#fabAdd').onclick=addTimestamp;
$('#fabBack').onclick=()=>{ const t=(player?.getCurrentTime?.()||0)-5; player.seekTo(Math.max(0,t),true); };
$('#fabFwd').onclick=()=>{ const t=(player?.getCurrentTime?.()||0)+5; player.seekTo(t,true); };

/* ---------- Notes toggle ---------- */
$('#toggleNotes').onclick=()=>{
  const cur = document.body.getAttribute('data-hide-notes') === '1';
  document.body.setAttribute('data-hide-notes', cur ? '0' : '1');
  $('#toggleNotes').textContent = (cur ? '隐藏备注：关' : '隐藏备注：开');
};

/* ---------- Backseek setting ---------- */
$('#backseek').addEventListener('change', e=>{
  const v = parseInt(e.target.value||'0',10) || 0; setBackseek(v); e.target.value = getBackseek();
});

/* ---------- Markdown Export ---------- */
function youtubeJumpUrl(id, sec){ return `https://youtu.be/${id}?t=${sec}`; }
function mdEscape(s=''){ return String(s).replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
function buildMarkdown(){
  const vid = currentVideoId || parseVideoId(document.getElementById('url').value.trim()) || 'video';
  const videoUrl = document.getElementById('url').value.trim() || `https://youtu.be/${vid}`;
  const nowISO = new Date().toISOString().slice(0,10);
  let md = `# YouTube 听力练习\n\n`;
  md += `- **日期**：${nowISO}\n`;
  md += `- **视频链接**：${videoUrl}\n`;
  md += `- **倒退秒数**：${getBackseek()}s\n\n`;
  const sortedMarks = [...timeMarks].sort((a,b)=>a.t-b.t);
  md += `## 时间点（可点击回放）\n`;
  md += (sortedMarks.length? sortedMarks.map(m=>{
      const ts = fmtTime(m.t); const link = youtubeJumpUrl(vid, m.t); const note = m.label ? (" — " + mdEscape(m.label)) : "";
      return `- [${ts}](${link})${note}`; }).join('\n') : `> 暂无时间点`) + '\n\n';
  md += `---\n*导出自 YT Study（一键 Markdown 导出）*\n`;
  return md;
}
async function exportMarkdown(){
  const md = buildMarkdown();
  const ok = await copyText(md);
  const vid = currentVideoId || parseVideoId(document.getElementById('url').value.trim()) || 'video';
  const blob = new Blob([md], {type:'text/markdown;charset=utf-8'});
  const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `${vid}_study.md`; a.click(); URL.revokeObjectURL(a.href);
  if (ok) { console.log('Markdown 已复制到剪贴板并下载'); }
}
document.getElementById('exportMD').addEventListener('click', exportMarkdown);

/* ---------- Init ---------- */
window.addEventListener('DOMContentLoaded', ()=>{
  if(!isHttp){ console.warn('请通过 HTTPS 打开，file:// 会导致播放器不可用'); }
  $('#backseek').value = getBackseek();
});
</script>
</body>
</html>
