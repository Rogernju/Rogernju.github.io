<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover" />
<title>YT Studyï¼ˆiOS å®‰è£…ç‰ˆ Â· v7ï¼‰</title>

<link rel="manifest" href="./manifest.webmanifest">
<meta name="theme-color" content="#0b0d10">
<link rel="apple-touch-icon" href="./icons/icon-192.png">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

<style>
  :root {
    --bg:#0b0d10; --panel:#12161b; --muted:#98a2b3; --text:#e6edf3; --accent:#4da3ff;
    --border:#1f2630; --danger:#ef4444;
    --safe-top: env(safe-area-inset-top, 0px);
    --safe-bottom: env(safe-area-inset-bottom, 0px);
  }
  @media (prefers-color-scheme: light) {
    :root {
      --bg:#f6f7fb; --panel:#ffffff; --muted:#667085; --text:#0b1321; --accent:#2b7cff;
      --border:#e5e7eb; --danger:#dc2626;
    }
  }

  *{box-sizing:border-box}
  html, body { height: 100%; }
  body{
    margin:0;
    padding-top: calc(var(--safe-top) + 8px);
    font:16px/1.5 -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "PingFang SC", "Microsoft YaHei", sans-serif;
    background:var(--bg); color:var(--text);
  }
  header,main{max-width:1100px;margin:0 auto;padding:12px}
  .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  .row.tight{gap:6px}
  input{background:var(--panel);color:var(--text);border:1px solid var(--border);border-radius:10px;padding:10px 12px;outline:0;font-size:16px}
  input[type="text"]{flex:1 1 520px}
  input[type="number"]{width:70px}
  .iconbtn{min-width:44px;height:44px;border-radius:12px;border:1px solid var(--border);background:transparent;color:var(--text);display:flex;align-items:center;justify-content:center;cursor:pointer;padding:0 10px;font-size:20px}
  .iconbtn.primary{ background:var(--accent); color:#001b33; border:none; }
  .card{background:var(--panel);border:1px solid var(--border);border-radius:14px;padding:12px}

  /* Sticky player */
  .sticky { position: sticky; top: calc(var(--safe-top) + 8px); z-index: 20; }
  #playerWrap{aspect-ratio:16/9;background:#000;border-radius:12px;overflow:hidden;position:relative}

  /* Timestamp list */
  .list{display:flex;flex-direction:column;gap:8px;max-height:60vh;overflow:auto}
  .item{border:1px dashed var(--border);border-radius:10px;padding:8px;display:grid;grid-template-columns:auto 1fr auto;gap:8px;align-items:center}
  .item .del{width:32px;height:32px;border-radius:16px;background:transparent;border:1px solid var(--danger);color:var(--danger);font-weight:900;display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:18px}
  .item .del.confirm{ background:var(--danger); color:#fff; }
  .item .note{width:100%;padding:8px 10px;border-radius:8px;border:1px solid var(--border);background:transparent;color:var(--text);font-size:16px}
  .item .timebtn{padding:8px 12px;border-radius:999px;border:1px solid var(--border);background:transparent;color:var(--accent);font-weight:700;cursor:pointer;white-space:nowrap}
  .item .note-ghost{display:none;padding:8px 10px;border-radius:8px;border:1px dashed var(--border);background:transparent;color:var(--muted);font-size:14px;cursor:pointer}
  body[data-hide-notes="1"] .item .note { display:none; }
  body[data-hide-notes="1"] .item .note-ghost { display:block; }
  body[data-hide-notes="1"] .item { grid-template-columns:auto 1fr auto; }
  .item.peek .note { display:block !important; }
  .item.peek .note-ghost { display:none !important; }

  /* Floating buttons: back | fwd | add */
  .fab{position: fixed; bottom: calc(var(--safe-bottom) + 16px); z-index: 50; width:56px; height:56px; border-radius:28px; font-size:22px;
       display:flex; align-items:center; justify-content:center; box-shadow:0 8px 24px rgba(0,0,0,.35);}
  #fabAdd{ right: 16px; background:var(--accent); color:#001b33; }
  #fabFwd{ right: calc(16px + 56px + 12px); background:#1f2a37; color:#e2e8f0; border:1px solid var(--border);}
  #fabBack{ right: calc(16px + (56px + 12px)*2); background:#1f2a37; color:#e2e8f0; border:1px solid var(--border);}
  @media (prefers-color-scheme: light){
    #fabBack,#fabFwd{ background:#eef2ff; color:#1e293b; border:1px solid #c7d2fe; }
  }

  .tiny{font-size:12px;color:var(--muted)}

  /* History panel */
  #historyPanel{
    position: fixed; top: 0; right: 0; width: min(92vw, 420px); height: 100vh; background: var(--panel);
    border-left: 1px solid var(--border); box-shadow: -8px 0 24px rgba(0,0,0,.25);
    transform: translateX(100%); transition: transform .25s ease; z-index: 60; padding: 12px;
    display: grid; grid-template-rows: auto 1fr auto; gap: 10px;
    padding-top: calc(var(--safe-top) + 16px); /* notch safe space */
  }
  #historyPanel.open{ transform: translateX(0); }
  #historyList{ overflow:auto; display:flex; flex-direction:column; gap:8px; }
  .hitem{ border:1px solid var(--border); border-radius:10px; padding:8px; display:grid; grid-template-columns:1fr auto; gap:8px; align-items:center; }
  .hmeta{font-size:12px; color: var(--muted);}
  .hops{ display:flex; gap:6px; }
  .chip{ padding:4px 8px; border-radius:999px; border:1px solid var(--border); font-size:12px; color: var(--muted); }

</style>
</head>
<body>
<header class="card sticky">
  <div id="playerWrap"><div id="player"></div></div>
  <div class="row tight" style="margin-top:10px">
    <input id="url" type="text" placeholder="ç²˜è´´ YouTube é“¾æ¥ï¼Œä¾‹å¦‚ https://www.youtube.com/watch?v=dQw4w9WgXcQ" />
    <button id="loadBtn" class="iconbtn primary" title="Load" aria-label="Load">â¬‡ï¸</button>

    <span class="tiny">å€’é€€</span>
    <input id="backseek" type="number" min="0" step="1" value="3" />

    <button id="toggleNotes" class="iconbtn" title="éšè—å¤‡æ³¨" aria-label="éšè—å¤‡æ³¨">ğŸ™ˆ</button>
    <button id="exportMD" class="iconbtn" title="å¯¼å‡º Markdown" aria-label="å¯¼å‡º Markdown">ğŸ“</button>
    <button id="openHistory" class="iconbtn" title="å†å²" aria-label="å†å²">ğŸ•˜</button>

    <span class="tiny">å½“å‰ <span id="curTime">0:00</span></span>
  </div>
</header>

<main>
  <section class="card">
    <h3>æ—¶é—´ç‚¹</h3>
    <div class="list" id="timeList"></div>
  </section>
</main>

<!-- Floating Buttons: back | fwd | add -->
<button id="fabBack" class="fab" title="åé€€ -5s" aria-label="åé€€ -5s">âª</button>
<button id="fabFwd" class="fab" title="å‰è¿› +5s" aria-label="å‰è¿› +5s">â©</button>
<button id="fabAdd" class="fab" title="è®°å½•æ—¶é—´ç‚¹" aria-label="è®°å½•æ—¶é—´ç‚¹">â•</button>

<!-- History Panel -->
<aside id="historyPanel" aria-label="å†å²è®°å½•">
  <div class="row">
    <strong style="font-size:18px">å†å²è®°å½•</strong>
    <span class="chip" id="histCount">0 é¡¹</span>
    <span style="flex:1"></span>
    <button id="closeHistory" class="iconbtn" title="å…³é—­" aria-label="å…³é—­">âŒ</button>
  </div>
  <div id="historyList"></div>
  <div class="tiny">æç¤ºï¼šé•¿æŒ‰æ¡ç›®å¯é‡å‘½åï¼›ç‚¹â€œæ‰“å¼€â€åˆ‡æ¢åˆ°è¯¥è§†é¢‘ï¼›åˆ é™¤ä¸å¯æ¢å¤ã€‚</div>
</aside>

<script>
/* ---------- Utils ---------- */
const $=s=>document.querySelector(s);
const fmtTime=s=>{s=Math.max(0,Math.floor(s||0));const h=Math.floor(s/3600),m=Math.floor((s%3600)/60),sec=s%60;return (h?(h+':'):'')+(h?String(m).padStart(2,'0'):m)+':'+String(sec).padStart(2,'0')};
const parseVideoId=u=>{try{if(!u)return'';const x=new URL(u);if(x.hostname.includes('youtu.be'))return x.pathname.slice(1);if(x.searchParams.get('v'))return x.searchParams.get('v');if(x.pathname.startsWith('/shorts/'))return x.pathname.split('/')[2]||'';return''}catch(e){return u}};
const isHttp=location.protocol.startsWith('http');

/* ---------- Clipboard auto-fill (best effort) ---------- */
let clipboardTried = false;
async function tryFillFromClipboard(){
  if(clipboardTried) return; clipboardTried = true;
  if(!navigator.clipboard || !isHttp) return; // needs https
  try{
    // Some browsers require user gesture; this function is bound to first interaction and visibilitychange as fallback.
    const text = await navigator.clipboard.readText();
    if(!$('#url').value && /https?:\/\/(www\.)?(youtube\.com|youtu\.be)\//i.test(text)){
      $('#url').value = text.trim();
      console.log('å·²ä»å‰ªè´´æ¿å¡«å……é“¾æ¥');
    }
  }catch(e){ /* ignore */ }
}
['pointerdown','keydown','focus'].forEach(ev=>{
  window.addEventListener(ev, tryFillFromClipboard, { once:true, capture:true });
});
document.addEventListener('visibilitychange', ()=>{
  if(document.visibilityState==='visible') tryFillFromClipboard();
});

/* ---------- Clipboard helper ---------- */
async function copyText(t){
  try{ if(navigator.clipboard && isHttp){ await navigator.clipboard.writeText(t); return true; } }catch(e){}
  const ta=document.createElement('textarea'); ta.value=t; ta.style.position='fixed'; ta.style.opacity='0'; document.body.appendChild(ta);
  ta.focus(); ta.select(); const ok=document.execCommand('copy'); document.body.removeChild(ta); return ok;
}

/* ---------- YouTube IFrame API ---------- */
let player, currentVideoId='', timeTick;
function onYouTubeIframeAPIReady(){
  player=new YT.Player('player',{
    width:'100%',height:'100%',
    videoId:'',
    playerVars:{
      playsinline:1, cc_load_policy:1, enablejsapi:1,
      origin: isHttp?location.origin:undefined,
      modestbranding:1, rel:0, iv_load_policy:3, fs:1
    },
    events:{ onReady:onPlayerReady }
  });
}
function onPlayerReady(){ timeTick=setInterval(()=>{ if(player && player.getCurrentTime){ $('#curTime').textContent=fmtTime(player.getCurrentTime()); }},300); }
(function loadYT(){ const s=document.createElement('script'); s.src="https://www.youtube.com/iframe_api"; document.head.appendChild(s); })();

/* ---------- State ---------- */
const storeKeyGlobal=k=>`ytstudy:${k}`;
const storeKey=k=>`ytstudy:${currentVideoId}:${k}`;
let timeMarks=[];

function saveState(){ if(!currentVideoId) return; localStorage.setItem(storeKey('timeMarks'),JSON.stringify(timeMarks)); upsertHistoryMeta(); }
function loadState(){ timeMarks=JSON.parse(localStorage.getItem(storeKey('timeMarks'))||'[]'); renderTimeMarks(); }

function getBackseek(){ return parseInt(localStorage.getItem(storeKeyGlobal('backseek'))||'3',10) || 0; }
function setBackseek(v){ localStorage.setItem(storeKeyGlobal('backseek'), String(Math.max(0, Math.floor(v||0)))); }

/* ---------- History (localStorage index) ---------- */
function readHistoryIndex(){
  try{ return JSON.parse(localStorage.getItem('ytstudy:index')||'[]'); }catch(e){ return []; }
}
function writeHistoryIndex(arr){ localStorage.setItem('ytstudy:index', JSON.stringify(arr)); renderHistory(); }

async function fetchTitleFor(url){
  try{
    const o = await fetch(`https://www.youtube.com/oembed?url=${encodeURIComponent(url)}&format=json`);
    if(!o.ok) throw 0;
    const data = await o.json();
    return data.title || '';
  }catch(e){ return ''; }
}

async function upsertHistoryMeta(){
  if(!currentVideoId) return;
  const url = $('#url').value.trim() || `https://youtu.be/${currentVideoId}`;
  const now = Date.now();
  const idx = readHistoryIndex();
  const i = idx.findIndex(x => x.videoId === currentVideoId);
  let title = (i>=0 && idx[i].title) ? idx[i].title : '';
  if(!title){
    title = await fetchTitleFor(url); // best effort
  }
  const meta = { videoId: currentVideoId, url, title, createdAt: (idx[i]?.createdAt||now), updatedAt: now, count: timeMarks.length };
  if(i>=0) idx[i] = meta; else idx.push(meta);
  writeHistoryIndex(idx);
}
function deleteHistory(videoId){
  const idx = readHistoryIndex().filter(x=>x.videoId!==videoId);
  localStorage.removeItem(`ytstudy:${videoId}:timeMarks`);
  writeHistoryIndex(idx);
}
function renameHistory(videoId, newTitle){
  const idx = readHistoryIndex();
  const i = idx.findIndex(x=>x.videoId===videoId);
  if(i>=0){ idx[i].title = (newTitle||""); writeHistoryIndex(idx); }
}
function openHistory(videoId, url){
  $('#url').value = url || `https://youtu.be/${videoId}`;
  currentVideoId = videoId;
  player.loadVideoById(videoId);
  loadState();
  document.getElementById('historyPanel').classList.remove('open');
}

/* Render history panel */
function renderHistory(){
  const list = $('#historyList');
  const idx = readHistoryIndex().sort((a,b)=> (b.updatedAt||0) - (a.updatedAt||0));
  $('#histCount').textContent = `${idx.length} é¡¹`;
  list.innerHTML = '';
  const fmtDate = ts => { try{ const d = new Date(ts); return d.toLocaleString(); }catch(e){ return ''; } };
  idx.forEach(item=>{
    const div = document.createElement('div'); div.className='hitem';
    const title = (item.title && item.title.trim()) ? item.title.trim() : (item.url || item.videoId);
    div.innerHTML = `<div>
        <div style="font-weight:700;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${title}</div>
        <div class="hmeta">å…± ${item.count||0} æ¡ Â· æ›´æ–°äº ${fmtDate(item.updatedAt)}</div>
      </div>
      <div class="hops">
        <button class="iconbtn" title="æ‰“å¼€" data-act="open" data-id="${item.videoId}" aria-label="æ‰“å¼€">ğŸ“º</button>
        <button class="iconbtn" title="é‡å‘½å" data-act="rename" data-id="${item.videoId}" aria-label="é‡å‘½å">âœï¸</button>
        <button class="iconbtn" title="åˆ é™¤" data-act="del" data-id="${item.videoId}" aria-label="åˆ é™¤">ğŸ—‘ï¸</button>
      </div>`;
    // long press rename quick
    div.addEventListener('mousedown', (e)=>{
      let timer = setTimeout(()=>{
        const nt = prompt('è¾“å…¥æ–°æ ‡é¢˜ï¼ˆå¯ç•™ç©ºï¼‰ï¼š', item.title||'');
        if(nt!==null){ renameHistory(item.videoId, nt); }
      }, 600);
      const clear=()=>{ clearTimeout(timer); document.removeEventListener('mouseup', clear); document.removeEventListener('touchend', clear); };
      document.addEventListener('mouseup', clear); document.addEventListener('touchend', clear);
    }, {passive:true});
    list.appendChild(div);
  });
  // ops
  list.querySelectorAll('.hops .iconbtn').forEach(btn=>{
    const act = btn.getAttribute('data-act');
    const vid = btn.getAttribute('data-id');
    btn.onclick = ()=>{
      const item = readHistoryIndex().find(x=>x.videoId===vid);
      if(act==='open'){ openHistory(vid, item?.url); }
      if(act==='rename'){ const nt = prompt('è¾“å…¥æ–°æ ‡é¢˜ï¼ˆå¯ç•™ç©ºï¼‰ï¼š', item?.title||''); if(nt!==null){ renameHistory(vid, nt); } }
      if(act==='del'){ if(confirm('ç¡®å®šåˆ é™¤è¯¥å†å²åŠå…¶æ—¶é—´æˆ³ï¼Ÿä¸å¯æ¢å¤ã€‚')) deleteHistory(vid); }
    };
  });
}
document.getElementById('openHistory').onclick = ()=>{
  renderHistory(); document.getElementById('historyPanel').classList.add('open');
};
document.getElementById('closeHistory').onclick = ()=>{
  document.getElementById('historyPanel').classList.remove('open');
};

/* ---------- Timestamps UI with two-tap delete ---------- */
const tapConfirmMap = new Map(); // i -> timeoutId
function renderTimeMarks(){
  const box=$('#timeList'); box.innerHTML='';
  timeMarks.sort((a,b)=>a.t-b.t).forEach((m,i)=>{
    const d=document.createElement('div'); d.className='item';
    d.innerHTML=`<button class="del" data-i="${i}" title="åˆ é™¤">âŒ</button>
      <input class="note" data-i="${i}" value="${(m.label||'').replace(/"/g,'&quot;')}" placeholder="å¤‡æ³¨ï¼ˆå¯ç¼–è¾‘ï¼‰" />
      <div class="note-ghost" data-i="${i}">ï¼ˆå¤‡æ³¨å·²éšè—ï¼Œè½»ç‚¹æ˜¾ç¤ºï¼‰</div>
      <button class="timebtn" data-i="${i}">â± ${fmtTime(m.t)}</button>`;
    box.appendChild(d);
  });
  const back = getBackseek();
  box.querySelectorAll('button.del').forEach(btn=> btn.onclick=()=>{
    const i=+btn.getAttribute('data-i');
    if(tapConfirmMap.has(i)){
      clearTimeout(tapConfirmMap.get(i)); tapConfirmMap.delete(i);
      timeMarks.splice(i,1); renderTimeMarks(); saveState();
    } else {
      btn.classList.add('confirm');
      btn.textContent='â—';
      const tid = setTimeout(()=>{
        btn.classList.remove('confirm'); btn.textContent='âŒ'; tapConfirmMap.delete(i);
      }, 2500);
      tapConfirmMap.set(i, tid);
    }
  });
  box.querySelectorAll('button.timebtn').forEach(btn=> btn.onclick=()=>{
    const i=+btn.getAttribute('data-i'); const m=timeMarks[i]; if(!m) return;
    const start=Math.max(0,(m.t||0)-back); player?.seekTo?.(start,true); player?.playVideo?.();
  });
  box.querySelectorAll('input.note').forEach(inp=> inp.oninput=()=>{
    const i=+inp.getAttribute('data-i'); if(timeMarks[i]){ timeMarks[i].label=inp.value; saveState(); }
  });
  box.querySelectorAll('.note-ghost').forEach(el=> el.onclick=()=>{
    const item=el.closest('.item'); if(!item) return;
    item.classList.add('peek'); setTimeout(()=> item.classList.remove('peek'), 6000);
  });
}

/* ---------- Load video ---------- */
async function doLoad(){
  const id=parseVideoId($('#url').value.trim()); if(!id){ alert('è¯·ç²˜è´´æœ‰æ•ˆçš„é“¾æ¥'); return; }
  currentVideoId=id;
  player.loadVideoById(id);
  timeMarks=[]; renderTimeMarks(); saveState(); loadState();
  $('#backseek').value = getBackseek();
}
document.getElementById('loadBtn').onclick=doLoad;

/* ---------- FABs ---------- */
function addTimestamp(){ const t=Math.floor(player?.getCurrentTime?.()||0); timeMarks.push({t,label:''}); renderTimeMarks(); saveState(); }
$('#fabAdd').onclick=addTimestamp;
$('#fabBack').onclick=()=>{ const t=(player?.getCurrentTime?.()||0)-5; player.seekTo(Math.max(0,t),true); };
$('#fabFwd').onclick=()=>{ const t=(player?.getCurrentTime?.()||0)+5; player.seekTo(t,true); };

/* ---------- Notes toggle ---------- */
let hideNotes=false;
$('#toggleNotes').onclick=()=>{
  hideNotes = !hideNotes;
  document.body.setAttribute('data-hide-notes', hideNotes ? '1' : '0');
  $('#toggleNotes').textContent = hideNotes ? 'ğŸ‘€' : 'ğŸ™ˆ';
  $('#toggleNotes').title = hideNotes ? 'æ˜¾ç¤ºå¤‡æ³¨' : 'éšè—å¤‡æ³¨';
};

/* ---------- Backseek setting ---------- */
$('#backseek').addEventListener('change', e=>{
  const v = parseInt(e.target.value||'0',10) || 0; setBackseek(v); e.target.value = getBackseek();
});

/* ---------- Markdown Export ---------- */
function youtubeJumpUrl(id, sec){ return `https://youtu.be/${id}?t=${sec}`; }
function mdEscape(s=''){ return String(s).replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
function buildMarkdown(){
  const vid = currentVideoId || parseVideoId(document.getElementById('url').value.trim()) || 'video';
  const videoUrl = document.getElementById('url').value.trim() || `https://youtu.be/${vid}`;
  const nowISO = new Date().toISOString().slice(0,10);
  let md = `# YouTube å¬åŠ›ç»ƒä¹ \n\n`;
  md += `- **æ—¥æœŸ**ï¼š${nowISO}\n`;
  md += `- **è§†é¢‘é“¾æ¥**ï¼š${videoUrl}\n`;
  md += `- **å€’é€€ç§’æ•°**ï¼š${getBackseek()}s\n\n`;
  const sortedMarks = [...timeMarks].sort((a,b)=>a.t-b.t);
  md += `## æ—¶é—´ç‚¹ï¼ˆå¯ç‚¹å‡»å›æ”¾ï¼‰\n`;
  md += (sortedMarks.length? sortedMarks.map(m=>{
      const ts = fmtTime(m.t); const link = youtubeJumpUrl(vid, m.t); const note = m.label ? (" â€” " + mdEscape(m.label)) : "";
      return `- [${ts}](${link})${note}`; }).join('\n') : `> æš‚æ— æ—¶é—´ç‚¹`) + '\n\n';
  md += `---\n*å¯¼å‡ºè‡ª YT Studyï¼ˆä¸€é”® Markdown å¯¼å‡ºï¼‰*\n`;
  return md;
}
async function exportMarkdown(){
  const md = buildMarkdown();
  const ok = await copyText(md);
  const vid = currentVideoId || parseVideoId(document.getElementById('url').value.trim()) || 'video';
  const blob = new Blob([md], {type:'text/markdown;charset=utf-8'});
  const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `${vid}_study.md`; a.click(); URL.revokeObjectURL(a.href);
  if (ok) { console.log('Markdown å·²å¤åˆ¶åˆ°å‰ªè´´æ¿å¹¶ä¸‹è½½'); }
}
document.getElementById('exportMD').addEventListener('click', exportMarkdown);

/* ---------- Init ---------- */
window.addEventListener('DOMContentLoaded', ()=>{
  if(!isHttp){ console.warn('è¯·é€šè¿‡ HTTPS æ‰“å¼€ï¼Œfile:// ä¼šå¯¼è‡´æ’­æ”¾å™¨ä¸å¯ç”¨'); }
  $('#backseek').value = getBackseek();
  renderHistory();
});
</script>
</body>
</html>
