<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>YouTube å¬åŠ›æ ‡æ³¨ä¸è¯ç»„å­¦ä¹ ï¼ˆå•é¡µç‰ˆï¼‰</title>
<style>
  :root{
    --bg:#0b0c0f; --card:#151821; --muted:#A0A4AE; --text:#EDEEF1; --accent:#6AA8FF; --line:#232735;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);font:14px/1.5 system-ui,Segoe UI,Roboto,Helvetica,Arial}
  header{padding:16px 20px;border-bottom:1px solid var(--line);display:flex;gap:12px;flex-wrap:wrap;align-items:center}
  header input[type="url"], header input[type="text"]{flex:1;min-width:280px;padding:10px 12px;background:#0f1220;color:var(--text);border:1px solid var(--line);border-radius:8px}
  header button, .btn{padding:10px 14px;border:1px solid var(--line);background:#1d2230;color:var(--text);border-radius:8px;cursor:pointer}
  header button:hover, .btn:hover{background:#252b3d}
  .pill{padding:6px 10px;border-radius:99px;background:#1b2030;border:1px solid var(--line);font-size:12px;color:var(--muted)}
  main{display:grid;grid-template-columns: 1.4fr 1fr;gap:16px;padding:16px}
  .card{background:var(--card);border:1px solid var(--line);border-radius:12px;overflow:hidden}
  .card header{padding:10px 12px;border-bottom:1px solid var(--line);font-weight:600;background:#121522}
  .card .content{padding:12px}
  #playerWrap{aspect-ratio:16/9;background:#0e1120;display:grid;place-items:center}
  .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  .row > *{margin:4px 0}
  .small{font-size:12px;color:var(--muted)}
  textarea, .mono{width:100%;min-height:120px;background:#0f1220;color:var(--text);border:1px solid var(--line);border-radius:8px;padding:10px 12px;resize:vertical;font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace}
  .segments{max-height:320px;overflow:auto;border:1px solid var(--line);border-radius:8px}
  .seg{padding:8px 10px;border-bottom:1px dashed #20263a;cursor:text}
  .seg:hover{background:#11162a}
  .seg .ts{font-size:12px;color:var(--muted);margin-right:6px}
  .highlight{background:rgba(255,238,88,.25);border-bottom:1px solid #ffee58}
  table{width:100%;border-collapse:collapse}
  th, td{border-bottom:1px solid var(--line);padding:8px 10px;vertical-align:top}
  th{position:sticky;top:0;background:#121522;text-align:left}
  .tag{display:inline-block;padding:2px 6px;border:1px solid var(--line);border-radius:6px;margin-right:6px;color:var(--muted);font-size:12px}
  .right{margin-left:auto}
  .kbd{padding:0 6px;border:1px solid var(--line);border-radius:6px;background:#101426;color:var(--muted);font-size:12px}
  .danger{border-color:#5a1e2a;background:#2b121a}
  .success{border-color:#1e5a34;background:#102515}
  .nowrap{white-space:nowrap}
  .muted{color:var(--muted)}
  @media (max-width: 1024px){ main{grid-template-columns: 1fr}}
</style>
</head>
<body>
<header>
  <span class="pill">YouTube å¬åŠ›ç»ƒä¹ å·¥å…· Â· æœ¬åœ°å­˜å‚¨</span>
  <input id="urlInput" type="url" placeholder="ç²˜è´´ YouTube é“¾æ¥ï¼Œä¾‹å¦‚ï¼šhttps://www.youtube.com/watch?v=VIDEO_ID" />
  <button id="loadBtn">åŠ è½½è§†é¢‘</button>
  <button id="markBtn" title="å¿«æ·é”® T">æ·»åŠ æ—¶é—´ç‚¹</button>
  <button id="saveBtn">ä¿å­˜å½“å‰æ•°æ®</button>
  <span id="status" class="small"></span>
</header>

<main>
  <section class="card">
    <header>æ’­æ”¾å™¨ä¸æ—¶é—´ç‚¹</header>
    <div class="content">
      <div id="playerWrap"><div id="player"></div></div>
      <div class="row" style="margin-top:10px">
        <button class="btn" id="tryCaption">å°è¯•è‡ªåŠ¨è·å–è‹±æ–‡å­—å¹•</button>
        <button class="btn" id="clearPoints">æ¸…ç©ºæ—¶é—´ç‚¹</button>
        <button class="btn" id="exportPoints">å¯¼å‡ºæ—¶é—´ç‚¹ CSV</button>
        <span class="small">å¿«æ·é”®ï¼š<span class="kbd">T</span> æ·»åŠ æ—¶é—´ç‚¹ Â· <span class="kbd">S</span> ä¿å­˜é€‰ä¸­è¯ç»„</span>
      </div>
      <div id="points" class="segments" style="margin-top:10px"></div>
    </div>
  </section>

  <section class="card">
    <header>å­—å¹•ä¸å­¦ä¹ æ¸…å•</header>
    <div class="content">
      <div class="row">
        <button class="btn" id="pasteToggle">æˆ‘æ¥æ‰‹åŠ¨ç²˜è´´å­—å¹•</button>
        <button class="btn" id="exportLex">å¯¼å‡ºå­¦ä¹ æ¸…å• CSV</button>
        <button class="btn danger" id="clearLex">æ¸…ç©ºå­¦ä¹ æ¸…å•</button>
        <span class="right small muted">Tipsï¼šåœ¨ä¸‹æ–¹å­—å¹•åŒºç”¨é¼ æ ‡æ‹–æ‹½é€‰ä¸­ï¼ŒæŒ‰ <span class="kbd">S</span> æˆ–ç‚¹â€œä¿å­˜é€‰ä¸­è¯ç»„â€ã€‚</span>
      </div>
      <div id="pasteArea" style="display:none;margin-top:8px">
        <textarea id="manualCaption" placeholder="åœ¨æ­¤ç²˜è´´å­—å¹•æ–‡æœ¬ï¼ˆå¯å«æ—¶é—´è½´ï¼Œæˆ‘ä»¬ä¼šå°è¯•æ¸…æ´—ä¸ºçº¯æ–‡æœ¬ï¼‰"></textarea>
        <div class="row">
          <button class="btn success" id="useManual">ä½¿ç”¨ä»¥ä¸Šå­—å¹•</button>
          <span class="small muted">æ”¯æŒç›´æ¥ç²˜è´´ YouTube transcript æˆ–å…¶ä»–å­—å¹•æ–‡æœ¬</span>
        </div>
      </div>

      <div class="row" style="margin-top:8px">
        <button class="btn" id="saveSelection">ä¿å­˜é€‰ä¸­è¯ç»„</button>
        <input id="selNote" type="text" placeholder="å¯é€‰ï¼šç»™æœ¬æ¬¡é€‰ä¸­åŠ å¤‡æ³¨ï¼ˆå¦‚è¯æ€§ã€é‡Šä¹‰ç­‰ï¼‰" />
      </div>

      <div class="row" style="margin-top:8px">
        <div class="tag">æ¨¡å¼ï¼š<span id="capMode">å°šæœªåŠ è½½</span></div>
        <div class="tag">è¯­è¨€ï¼š<span id="capLang">-</span></div>
        <div class="tag">æ®µè½ï¼š<span id="capCount">0</span></div>
      </div>

      <div id="captionSegments" class="segments" style="margin-top:8px"></div>

      <h3 style="margin:14px 4px 4px">å­¦ä¹ æ¸…å•</h3>
      <div class="segments" style="max-height:none">
        <table id="lexTable">
          <thead>
            <tr>
              <th style="width:24%">è¯/è¯ç»„</th>
              <th>ä¸Šä¸‹æ–‡</th>
              <th class="nowrap">æ—¶é—´</th>
              <th style="width:24%">å¤‡æ³¨</th>
              <th class="nowrap">æ“ä½œ</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

    </div>
  </section>
</main>

<!-- YouTube IFrame API -->
<script>
  let player, videoId = "", state = {
    points: [],         // {t, label}
    captions: [],       // {start, dur, text, plain}
    plainText: "",      // æ•´ä½“æ— æ—¶é—´è½´æ–‡æœ¬
    lex: []             // å­¦ä¹ æ¸…å• {term, ctx, t, note}
  };

  // --- å·¥å…·å‡½æ•° ---
  const $ = s => document.querySelector(s);
  const fmt = s => s.toString().padStart(2,'0');
  function secToHMS(sec){
    sec = Math.max(0, Math.floor(sec||0));
    const h = Math.floor(sec/3600);
    const m = Math.floor((sec%3600)/60);
    const s2 = sec%60;
    return (h>0? `${h}:${fmt(m)}:${fmt(s2)}` : `${m}:${fmt(s2)}`);
  }
  function parseVideoId(url){
    try{
      const u = new URL(url);
      if(u.hostname.includes('youtu.be')) return u.pathname.slice(1);
      if(u.searchParams.get('v')) return u.searchParams.get('v');
      // embed/VIDEO_ID
      const parts = u.pathname.split('/');
      const idx = parts.indexOf('embed');
      if(idx>=0 && parts[idx+1]) return parts[idx+1];
    }catch{}
    return url; // å…œåº•ï¼šç›´æ¥å½“ä½œ ID
  }
  function saveLocal(){
    if(!videoId) return;
    localStorage.setItem(`ytl:${videoId}`, JSON.stringify(state));
    setStatus("å·²ä¿å­˜åˆ°æœ¬åœ°ã€‚");
  }
  function loadLocal(id){
    const raw = localStorage.getItem(`ytl:${id}`);
    if(!raw) return;
    try{
      state = JSON.parse(raw);
      renderPoints();
      renderCaptions();
      renderLex();
    }catch{}
  }
  function setStatus(msg){ $('#status').textContent = msg || ""; }

  // --- åˆå§‹åŒ– YouTube IFrame API ---
  // åŠ¨æ€æ³¨å…¥ API è„šæœ¬
  (function loadYT(){
    const tag = document.createElement('script');
    tag.src = "https://www.youtube.com/iframe_api";
    document.head.appendChild(tag);
  })();

  window.onYouTubeIframeAPIReady = function(){
    player = new YT.Player('player', {
      height: '100%',
      width: '100%',
      videoId: '',
      playerVars: { rel:0, modestbranding:1, enablejsapi:1, cc_load_policy:0 },
    });
  };

  // --- UI æ¸²æŸ“ ---
  function renderPoints(){
    const box = $('#points'); box.innerHTML = "";
    if(!state.points.length){ box.innerHTML = `<div class="small muted" style="padding:8px 10px">æš‚æ— æ—¶é—´ç‚¹ã€‚ç‚¹å‡»â€œæ·»åŠ æ—¶é—´ç‚¹â€æˆ–æŒ‰ Tã€‚</div>`; return; }
    state.points.forEach((p,i)=>{
      const div = document.createElement('div'); div.className = 'seg';
      div.innerHTML = `
        <span class="ts">â± ${secToHMS(p.t)}</span>
        <span>${escapeHTML(p.label||"æœªå‘½åæ ‡æ³¨")}</span>
        <span class="right" style="float:right">
          <button class="btn" data-j="${i}">è·³è½¬</button>
          <button class="btn danger" data-d="${i}">åˆ é™¤</button>
        </span>
      `;
      box.appendChild(div);
    });
  }

  function renderCaptions(){
    $('#capCount').textContent = state.captions.length;
    const mode = state.captions.length ? 'è‡ªåŠ¨/æ‰‹åŠ¨å­—å¹•' : 'æœªåŠ è½½';
    $('#capMode').textContent = mode;
    const container = $('#captionSegments'); container.innerHTML = "";
    if(!state.captions.length){
      container.innerHTML = `<div class="small muted" style="padding:8px 10px">å°šæ— å­—å¹•ã€‚å¯ç‚¹å‡»â€œå°è¯•è‡ªåŠ¨è·å–è‹±æ–‡å­—å¹•â€ï¼Œæˆ–â€œæˆ‘æ¥æ‰‹åŠ¨ç²˜è´´å­—å¹•â€ã€‚</div>`;
      return;
    }
    state.captions.forEach((c, i)=>{
      const div = document.createElement('div'); div.className = 'seg'; div.dataset.idx = i;
      div.innerHTML = `<span class="ts">ğŸ—£ ${secToHMS(c.start||0)}</span><span>${escapeHTML(c.text)}</span>`;
      container.appendChild(div);
    });
  }

  function renderLex(){
    const tbody = $('#lexTable tbody'); tbody.innerHTML = "";
    if(!state.lex.length){
      tbody.innerHTML = `<tr><td colspan="5" class="muted">æš‚æ— æ¡ç›®ã€‚å…ˆåœ¨å­—å¹•ä¸­åˆ’è¯ï¼Œç„¶åç‚¹å‡»â€œä¿å­˜é€‰ä¸­è¯ç»„â€ï¼ˆæˆ–æŒ‰ Sï¼‰ã€‚</td></tr>`;
      return;
    }
    state.lex.forEach((x,i)=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${escapeHTML(x.term)}</td>
        <td>${escapeHTML(x.ctx)}</td>
        <td class="nowrap">${x.t? secToHMS(x.t) : '-'}</td>
        <td>${escapeHTML(x.note||'')}</td>
        <td>
          <button class="btn" data-leap="${i}">è·³è½¬</button>
          <button class="btn danger" data-del="${i}">åˆ é™¤</button>
        </td>
      `;
      tbody.appendChild(tr);
    });
  }

  function escapeHTML(s=''){ return s.replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m])); }

  // --- äº‹ä»¶ç»‘å®š ---
  $('#loadBtn').addEventListener('click', ()=>{
    const raw = $('#urlInput').value.trim();
    if(!raw) return setStatus('è¯·å…ˆç²˜è´´é“¾æ¥');
    videoId = parseVideoId(raw);
    setStatus('å·²è§£æè§†é¢‘ IDï¼š' + videoId);
    if(player && player.loadVideoById) player.loadVideoById(videoId);
    // æ–°è§†é¢‘åˆå§‹åŒ– / è½½å…¥å†å²
    state = { points:[], captions:[], plainText:"", lex:[] };
    loadLocal(videoId);
    renderPoints(); renderCaptions(); renderLex();
  });

  $('#markBtn').addEventListener('click', addPoint);
  function addPoint(){
    if(!player || !player.getCurrentTime) return;
    const t = Math.floor(player.getCurrentTime());
    const label = prompt('ä¸ºè¯¥æ—¶é—´ç‚¹æ·»åŠ å¤‡æ³¨ï¼ˆå¯ç•™ç©ºï¼‰ï¼š', '');
    state.points.push({t, label: label||""});
    renderPoints(); saveLocal();
  }

  $('#points').addEventListener('click', (e)=>{
    const j = e.target.getAttribute('data-j');
    const d = e.target.getAttribute('data-d');
    if(j!==null){
      const p = state.points[+j]; if(p && player && player.seekTo){ player.seekTo(p.t, true); }
      return;
    }
    if(d!==null){
      state.points.splice(+d,1); renderPoints(); saveLocal();
    }
  });

  // å°è¯•æŠ“å–è‹±æ–‡å­—å¹•ï¼ˆäººå·¥ -> è‡ªåŠ¨ï¼‰
  $('#tryCaption').addEventListener('click', async ()=>{
    if(!videoId) return setStatus('è¯·å…ˆåŠ è½½è§†é¢‘');
    setStatus('å°è¯•è·å–è‹±æ–‡å­—å¹•â€¦');
    const tryUrls = [
      `https://video.google.com/timedtext?lang=en&v=${videoId}`,
      `https://video.google.com/timedtext?lang=en&kind=asr&v=${videoId}`
    ];
    for(const url of tryUrls){
      try{
        const res = await fetch(url);
        if(!res.ok) continue;
        const text = await res.text();
        const parsed = parseTimedTextXML(text);
        if(parsed.length){
          state.captions = parsed;
          $('#capLang').textContent = 'en';
          setStatus('å·²åŠ è½½å­—å¹•ã€‚å¯åœ¨å­—å¹•åŒºåˆ’è¯åŠ å…¥å­¦ä¹ æ¸…å•ã€‚');
          renderCaptions(); saveLocal();
          return;
        }
      }catch(err){
        // å¯èƒ½è¢« CORS é˜»æ­¢ï¼Œè¿›å…¥ä¸‹ä¸€ç§å°è¯•
      }
    }
    setStatus('æœªèƒ½è‡ªåŠ¨è·å–å­—å¹•ï¼ˆå¯èƒ½æ— è‹±æ–‡è½¨æˆ–è¢«è·¨åŸŸé˜»æ­¢ï¼‰ã€‚è¯·ç‚¹å‡»â€œæˆ‘æ¥æ‰‹åŠ¨ç²˜è´´å­—å¹•â€ã€‚');
  });

  // æ‰‹åŠ¨ç²˜è´´å­—å¹•
  $('#pasteToggle').addEventListener('click', ()=>{
    const area = $('#pasteArea');
    area.style.display = area.style.display==='none' ? 'block' : 'none';
  });
  $('#useManual').addEventListener('click', ()=>{
    const raw = $('#manualCaption').value.trim();
    if(!raw) return setStatus('è¯·å…ˆç²˜è´´å­—å¹•æ–‡æœ¬');
    const parsed = parseAnyCaption(raw);
    state.captions = parsed;
    $('#capLang').textContent = 'n/a';
    setStatus('å·²è½½å…¥æ‰‹åŠ¨å­—å¹•ã€‚');
    renderCaptions(); saveLocal();
  });

  // åˆ’è¯ä¿å­˜
  $('#saveSelection').addEventListener('click', saveSelection);
  function saveSelection(){
    const sel = window.getSelection();
    const term = (sel && sel.toString().trim()) || "";
    if(!term) return setStatus('æœªé€‰ä¸­æ–‡æœ¬');
    // å¯»æ‰¾ä¸Šä¸‹æ–‡ï¼šåŒ…å«è¯¥é€‰æ‹©çš„æ®µè½
    let ctx = "";
    let t = null;
    if(sel.rangeCount){
      const node = sel.anchorNode && sel.anchorNode.parentElement;
      const seg = node && node.closest('.seg');
      if(seg){
        ctx = seg.innerText.replace(/^ğŸ—£\s*\d+:\d+\s*/,'').trim();
        const idx = +seg.dataset.idx;
        if(!isNaN(idx) && state.captions[idx]) t = Math.floor(state.captions[idx].start || 0);
      }else{
        // è‹¥ä¸åœ¨æ®µè½ä¸­ï¼Œé€€åŒ–ä¸ºæ•´ä½“çº¯æ–‡æœ¬
        ctx = (state.plainText || state.captions.map(x=>x.text).join(' ')).slice(0,300);
      }
    }
    const note = $('#selNote').value.trim();
    state.lex.push({term, ctx, t, note});
    $('#selNote').value = "";
    renderLex(); saveLocal();
    setStatus('å·²åŠ å…¥å­¦ä¹ æ¸…å•ï¼š' + term);
  }

  // å­¦ä¹ æ¸…å•æ“ä½œ
  $('#lexTable').addEventListener('click', (e)=>{
    const leap = e.target.getAttribute('data-leap');
    const del = e.target.getAttribute('data-del');
    if(leap!==null){
      const item = state.lex[+leap];
      if(item && typeof item.t==='number' && player && player.seekTo) player.seekTo(item.t, true);
    }
    if(del!==null){
      state.lex.splice(+del,1); renderLex(); saveLocal();
    }
  });
  $('#exportLex').addEventListener('click', ()=>{
    const csv = toCSV([['term','context','time','note']].concat(
      state.lex.map(x=>[x.term, x.ctx, x.t!=null?secToHMS(x.t):'', x.note||''])
    ));
    download(csv, `lex_${videoId||'unknown'}.csv`, 'text/csv');
  });
  $('#clearLex').addEventListener('click', ()=>{
    if(confirm('ç¡®å®šæ¸…ç©ºå­¦ä¹ æ¸…å•ï¼Ÿ')){ state.lex = []; renderLex(); saveLocal(); }
  });

  // æ—¶é—´ç‚¹å¯¼å‡º/æ¸…ç©º
  $('#exportPoints').addEventListener('click', ()=>{
    const csv = toCSV([['time','label']].concat(
      state.points.map(p=>[secToHMS(p.t), p.label||''])
    ));
    download(csv, `points_${videoId||'unknown'}.csv`, 'text/csv');
  });
  $('#clearPoints').addEventListener('click', ()=>{
    if(confirm('ç¡®å®šæ¸…ç©ºæ—¶é—´ç‚¹ï¼Ÿ')){ state.points = []; renderPoints(); saveLocal(); }
  });

  // ä¿å­˜
  $('#saveBtn').addEventListener('click', saveLocal);

  // å¿«æ·é”®
  document.addEventListener('keydown', (e)=>{
    if(e.target && ['INPUT','TEXTAREA'].includes(e.target.tagName)) return; // åœ¨è¾“å…¥æ¡†ä¸­ä¸æ‹¦æˆª
    if(e.key.toLowerCase()==='t'){ e.preventDefault(); addPoint(); }
    if(e.key.toLowerCase()==='s'){ e.preventDefault(); saveSelection(); }
  });

  // ç‚¹å‡»å­—å¹•æ®µè·³è½¬
  $('#captionSegments').addEventListener('click', (e)=>{
    const seg = e.target.closest('.seg'); if(!seg) return;
    const idx = +seg.dataset.idx;
    if(!isNaN(idx) && state.captions[idx] && player && player.seekTo){
      player.seekTo(Math.floor(state.captions[idx].start||0), true);
    }
  });

  // --- å­—å¹•è§£æ ---
  function parseTimedTextXML(xmlText){
    // è§£æ YouTube timedtext XML: <transcript><text start="0.12" dur="1.23">Hello</text>â€¦</transcript>
    const out = [];
    const parser = new DOMParser();
    const doc = parser.parseFromString(xmlText, "text/xml");
    const nodes = doc.getElementsByTagName('text');
    for(const node of nodes){
      const start = parseFloat(node.getAttribute('start')||'0')||0;
      const dur = parseFloat(node.getAttribute('dur')||'0')||0;
      let text = node.textContent || '';
      text = text.replace(/\s+/g,' ').trim();
      if(text) out.push({start, dur, text});
    }
    // ç”Ÿæˆæ— æ—¶é—´è½´çº¯æ–‡æœ¬ï¼ˆç®€å•æ‹¼æ¥å¹¶åšå¥å­åˆå¹¶ï¼‰
    state.plainText = out.map(x=>x.text).join(' ').replace(/\s+/g,' ').trim();
    return out;
  }

  // å°è¯•ä»ä»»æ„æ–‡æœ¬ä¸­æŠ½å–å­—å¹•è¡Œ -> æ ‡å‡†ç»“æ„
  function parseAnyCaption(raw){
    // 1) è‹¥æ˜¯ XML
    if(raw.trim().startsWith('<')){
      try{ return parseTimedTextXML(raw); }catch{}
    }
    // 2) å»é™¤å¸¸è§æ—¶é—´æˆ³ï¼ˆ00:00:00 æˆ– 0:12 æˆ– 00:12.345ï¼‰
    const lines = raw.split(/\r?\n/).map(s=>s.trim()).filter(Boolean).map(s=>{
      s = s.replace(/^\d+\s*$/,''); // å»é™¤ SRT ç´¢å¼•è¡Œ
      s = s.replace(/^(\d{1,2}:)?\d{1,2}:\d{2}([.,]\d+)?\s*-->\s*(\d{1,2}:)?\d{1,2}:\d{2}([.,]\d+)?$/,''); // å»æ‰ SRT æ—¶é—´è½´è¡Œ
      s = s.replace(/^(\d{1,2}:)?\d{1,2}:\d{2}([.,]\d+)?\s*/,''); // è¡Œé¦–æ—¶é—´æˆ³
      return s.trim();
    }).filter(Boolean);
    const text = lines.join(' ').replace(/\s+/g,' ').trim();
    state.plainText = text;
    // ç®€å•åˆ‡å¥ä¸ºæ®µ
    const segs = text.split(/(?<=[.!?])\s+(?=[A-Z0-9])/).map(x=>x.trim()).filter(Boolean)
      .map(x=>({start:null, dur:null, text:x}));
    return segs;
  }

  // --- å¯¼å‡ºå·¥å…· ---
  function toCSV(rows){
    return rows.map(r=>r.map(cell=>{
      const s = (cell==null?'':String(cell)).replace(/"/g,'""');
      return `"${s}"`;
    }).join(',')).join('\r\n');
  }
  function download(content, filename, type='text/plain'){
    const blob = new Blob([content], {type});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob); a.download = filename; a.click();
    URL.revokeObjectURL(a.href);
  }
</script>
</body>
</html>